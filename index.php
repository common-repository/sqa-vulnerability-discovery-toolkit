<?php 
/**
 * Plugin Name: SQA Vulnerability Discovery Toolkit
 * Plugin URI: https://github.com/sqa-consulting/vulnerability_discovery_toolkit/
 * Description: Edit your NCSC Vulnerability Discovery security.txt file from the WordPress admin
 * Version: 1.1
 * Text Domain: vulnerability-discovery-toolkit
 * Author: SQA Consulting 
 * Author URI: https://www.sqa-consulting.com/
 * License: GPLv2 or above
 *
 * @category    WordPress
 * @author      Daniel Oates-Lee <https://www.sqa-consulting.com/>
 * @copyright   SQA Consulting
 * @license     GPLv2 https://github.com/sqa-consulting/vulnerability_discovery_toolkit/blob/main/LICENSE
 * 
 * NCSC Vulnerability DIscover Toolkit (https://www.ncsc.gov.uk/information/vulnerability-disclosure-toolkit)
 * 
 */

!defined('ABSPATH') && exit;
define('SQA_NVDT_PLUGIN_DIR', plugin_dir_path(__FILE__));
define('SQA_NVDT_PLUGIN_NAME', plugin_basename(__FILE__));
define('SQA_NVDT_HOME_PATH', get_home_path());

$sqa_nvdt_wellknown_path = '.well-known/';

// check if path exists and create if not
if (!file_exists(SQA_NVDT_HOME_PATH . $sqa_nvdt_wellknown_path)) {
    mkdir(SQA_NVDT_HOME_PATH . $sqa_nvdt_wellknown_path, 0755, true);
}

$sqa_nvdt_security_file = SQA_NVDT_HOME_PATH . $sqa_nvdt_wellknown_path . 'security.txt';
$sqa_nvdt_policy_file =  SQA_NVDT_HOME_PATH . $sqa_nvdt_wellknown_path . 'policy.txt';
if (file_exists($sqa_nvdt_security_file)) {
    $sqa_nvdt_security_open = file_get_contents( $sqa_nvdt_security_file );
}
if (file_exists($sqa_nvdt_policy_file)) {
    $sqa_nvdt_policy_open = file_get_contents( $sqa_nvdt_policy_file );
}

require_once SQA_NVDT_PLUGIN_DIR . 'inc/core.php';

// check if admin and show options
if (is_admin()) {
    require_once SQA_NVDT_PLUGIN_DIR . 'inc/options-page.php';
    sqa_nvdt_Admin_Page::init();
}

// check for empty security data
if (!empty(get_option('sqa_nvdt_security_content'))){
    file_put_contents( $sqa_nvdt_security_file, strip_tags(get_option('sqa_nvdt_security_content')));
}

// check for empty policy data
if (!empty(get_option('sqa_nvdt_policy_content'))){
    file_put_contents( $sqa_nvdt_policy_file, strip_tags(get_option('sqa_nvdt_policy_content')));
}

register_activation_hook(__FILE__, 'sqa_nvdt_activation');
register_deactivation_hook(__FILE__, 'sqa_nvdt_deactivation');
